{% extends 'reviv/base.html' %}
{% load static %}

{% block title %}REVIV - Preview{% endblock %}

{% block extra_css %}
<style>
    .preview-wrap {
        max-width: 1200px;
        margin: 0 auto;
    }

    .preview-header {
        text-align: center;
        margin-bottom: 2.5rem;
    }

    .preview-header h1 {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .preview-cta {
        margin-top: 1.25rem;
    }

    .comparison-wrapper {
        background: var(--bg-panel);
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 40px rgba(229, 9, 20, 0.10);
    }

    .image-compare {
        --pos: 50%;
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        max-height: 70vh;
        overflow: hidden;
        cursor: ew-resize;
        user-select: none;
        border: 1px solid var(--border-color);
        background: #000;
    }

    .image-compare img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    .image-before {
        position: absolute;
        inset: 0;
        clip-path: inset(0 calc(100% - var(--pos)) 0 0);
        filter: saturate(0.85) brightness(0.95);
    }

    .compare-slider {
        position: absolute;
        top: 0;
        bottom: 0;
        left: var(--pos);
        width: 3px;
        background: linear-gradient(180deg, var(--accent-red), rgba(229, 9, 20, 0.5));
        transform: translateX(-50%);
        z-index: 10;
        box-shadow: 0 0 20px var(--accent-glow);
    }

    .compare-slider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: rgba(8, 8, 8, 0.8);
        border: 2px solid var(--accent-red);
        box-shadow: 0 0 25px var(--accent-glow);
    }

    .compare-slider::after {
        content: '◀ ▶';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--accent-red);
        font-weight: 700;
        letter-spacing: 0.1em;
        font-size: 0.85rem;
        pointer-events: none;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        .preview-header h1 { font-size: 2.75rem; }
        .comparison-wrapper { padding: 1rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="preview-wrap">
    <div class="preview-header">
        <h1>PREVIEW</h1>
        <p class="subtitle">
            Slide to compare before and after. Log in to upload your own image.
        </p>
        <div class="preview-cta">
            <a class="btn" href="{% url 'account_login' %}">Login to Upload</a>
        </div>
    </div>

    <div class="comparison-wrapper">
        <div class="image-compare" id="imageCompare" aria-label="Before/After preview slider">
            <img src="{% static 'reviv/demo/after.png' %}" alt="After restoration" id="afterImage">
            <img class="image-before" src="{% static 'reviv/demo/before.jpg' %}" alt="Before restoration" id="beforeImage">
            <div class="compare-slider" id="compareSlider"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const imageCompare = document.getElementById('imageCompare');
    const compareSlider = document.getElementById('compareSlider');

    let isDragging = false;

    function setPositionPercentage(pct) {
        const clamped = Math.max(0, Math.min(pct, 100));
        imageCompare.style.setProperty('--pos', `${clamped}%`);
    }

    function updateFromClientX(clientX) {
        const rect = imageCompare.getBoundingClientRect();
        const x = clientX - rect.left;
        const pct = (x / rect.width) * 100;
        setPositionPercentage(pct);
    }

    function onMove(e) {
        if (!isDragging && e.type !== 'click') return;
        const point = e.type.startsWith('touch') ? e.touches[0] : e;
        updateFromClientX(point.clientX);
    }

    // Initialize immediately so the component is never "empty" while images load.
    setPositionPercentage(50);

    compareSlider.addEventListener('mousedown', () => { isDragging = true; });
    document.addEventListener('mouseup', () => { isDragging = false; });
    document.addEventListener('mousemove', onMove);
    imageCompare.addEventListener('click', onMove);

    compareSlider.addEventListener('touchstart', (e) => {
        isDragging = true;
        e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchend', () => { isDragging = false; });
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        onMove(e);
        e.preventDefault();
    }, { passive: false });

    window.addEventListener('resize', () => {
        // Keep it stable on resize.
        const current = getComputedStyle(imageCompare).getPropertyValue('--pos').trim();
        if (current) imageCompare.style.setProperty('--pos', current);
    });
</script>
{% endblock %}
